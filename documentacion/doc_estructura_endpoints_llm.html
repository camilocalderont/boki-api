<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis API y CompanyAgent</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .question-section {
            background: white;
            margin: 25px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .question-header {
            background: #34495e;
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .question-content {
            padding: 25px;
        }
        
        .option-card {
            background: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .option-recommended {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .option-eliminated {
            border-color: #dc3545;
            background: #f8d7da;
            opacity: 0.7;
        }
        
        .option-card h4 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .pros, .cons {
            padding: 15px;
            border-radius: 6px;
        }
        
        .pros {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .cons {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .api-endpoint {
            background: #e8f6ff;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .api-endpoint h4 {
            margin: 0 0 10px 0;
            color: #2980b9;
        }
        
        .method-post {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .method-get {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .method-put {
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .method-delete {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #34495e;
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .payload-example {
            background: #fff;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .payload-example h4 {
            margin-top: 0;
            color: #17a2b8;
        }
        
        .highlight-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .highlight-box h4 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç An√°lisis: CompanyAgent y Dise√±o de API</h1>
            <p>Evaluando la necesidad real de CompanyAgent y dise√±o √≥ptimo de endpoints</p>
        </div>

        <!-- Pregunta 1: Funci√≥n de CompanyAgent -->
        <div class="question-section">
            <div class="question-header">
                üìã Pregunta 1: ¬øCu√°l es la funci√≥n real de CompanyAgent?
            </div>
            <div class="question-content">
                <p><strong>Tu cuestionamiento es muy v√°lido.</strong> Como la tabla es nueva, analicemos si realmente agrega valor o es complejidad innecesaria.</p>

                <h3>üîç Opciones Analizadas:</h3>

                <div class="option-card option-eliminated">
                    <h4>‚ùå Opci√≥n A: CompanyAgent como "Compatibilidad Forzada"</h4>
                    <p>Mantener la tabla solo para seguir el patr√≥n que propuse inicialmente.</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <strong>‚úÖ Pros:</strong>
                            <ul>
                                <li>Consistencia con estructura inicial</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <strong>‚ùå Contras:</strong>
                            <ul>
                                <li>Complejidad innecesaria</li>
                                <li>JOIN adicional siempre</li>
                                <li>No aporta valor real</li>
                                <li>Over-engineering</li>
                            </ul>
                        </div>
                    </div>
                    <p><strong>Veredicto:</strong> ELIMINAR - No tiene sentido mantener complejidad sin beneficio.</p>
                </div>

                <div class="option-card">
                    <h4>ü§î Opci√≥n B: CompanyAgent como "Configuraci√≥n Global LLM"</h4>
                    <p>Un agente por empresa con configuraci√≥n global de LLM que se aplica a todos los flujos.</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <strong>‚úÖ Pros:</strong>
                            <ul>
                                <li>Configuraci√≥n LLM centralizada</li>
                                <li>Personalidad consistente</li>
                                <li>Par√°metros globales (modelo, temperatura)</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <strong>‚ùå Contras:</strong>
                            <ul>
                                <li>¬øQu√© pasa si quieren diferentes modelos por flujo?</li>
                                <li>Menos flexibilidad</li>
                                <li>JOIN siempre requerido</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="option-card option-recommended">
                    <h4>‚úÖ Opci√≥n C: ELIMINAR CompanyAgent (Recomendada)</h4>
                    <p>Estructura directa: Company ‚Üí CompanyFlowDefinition (con configuraci√≥n LLM incluida)</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <strong>‚úÖ Pros:</strong>
                            <ul>
                                <li>M√°xima simplicidad</li>
                                <li>Flexibilidad total por flujo</li>
                                <li>Menos JOINs</li>
                                <li>Configuraci√≥n LLM espec√≠fica por flujo</li>
                                <li>API m√°s simple</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <strong>‚ùå Contras:</strong>
                            <ul>
                                <li>Posible duplicaci√≥n de config LLM</li>
                                <li>No hay "personalidad global"</li>
                            </ul>
                        </div>
                    </div>
                    <p><strong>Veredicto:</strong> IMPLEMENTAR - La simplicidad supera los contras.</p>
                </div>

                <div class="highlight-box">
                    <h4>üí° Conclusi√≥n sobre CompanyAgent</h4>
                    <p><strong>ELIMINEMOS CompanyAgent.</strong> Cada flujo puede tener su propia configuraci√≥n LLM en CompanyFlowDefinition. 
                    Si en el futuro necesitamos configuraci√≥n global, siempre podemos agregar un campo json_llm_defaults en Company.</p>
                </div>
            </div>
        </div>

        <!-- Pregunta 2: Dise√±o de API -->
        <div class="question-section">
            <div class="question-header">
                üöÄ Pregunta 2: Dise√±o de API - ¬øEndpoint √∫nico o granular?
            </div>
            <div class="question-content">
                <p><strong>Tienes raz√≥n - desde el front es mejor acumular y enviar todo de una vez.</strong> Pero tambi√©n necesitamos granularidad para ediciones espec√≠ficas.</p>

                <h3>üìä Comparaci√≥n de Enfoques:</h3>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Aspecto</th>
                            <th>Endpoint √önico ("Fat API")</th>
                            <th>Endpoints Granulares</th>
                            <th>H√≠brido (Recomendado)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Experiencia Frontend</strong></td>
                            <td>Excelente - Una llamada</td>
                            <td>Compleja - M√∫ltiples llamadas</td>
                            <td>Flexible - Elige seg√∫n caso</td>
                        </tr>
                        <tr>
                            <td><strong>Transaccionalidad</strong></td>
                            <td>Perfecta - Todo o nada</td>
                            <td>Dif√≠cil - Rollback manual</td>
                            <td>Configurable</td>
                        </tr>
                        <tr>
                            <td><strong>Validaci√≥n</strong></td>
                            <td>Completa al final</td>
                            <td>Parcial por partes</td>
                            <td>Ambas opciones</td>
                        </tr>
                        <tr>
                            <td><strong>Debugging</strong></td>
                            <td>M√°s dif√≠cil</td>
                            <td>M√°s f√°cil</td>
                            <td>Balanceado</td>
                        </tr>
                        <tr>
                            <td><strong>Edici√≥n Parcial</strong></td>
                            <td>Overkill - Env√≠a todo</td>
                            <td>Perfecta - Solo lo necesario</td>
                            <td>Optimizada</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üéØ Estructura API Recomendada (H√≠brida):</h3>

                <div class="api-endpoint">
                    <h4><span class="method-post">POST</span> /api/companies/{companyId}/flows</h4>
                    <p><strong>Creaci√≥n completa</strong> - Endpoint "gordo" para crear flujo completo desde el frontend</p>
                    <div class="code-block">{
  "flow_definition": {
    "vc_flow_name": "ai_appointment",
    "vc_display_name": "Agendamiento con IA",
    "tx_system_prompt": "...",
    "tx_user_prompt_template": "...",
    "json_flow_config": {...},
    "json_llm_config": {
      "model": "gpt-4",
      "temperature": 0.7,
      "max_tokens": 400
    }
  },
  "steps": [...],
  "conditions": [...],
  "tools": [...]
}</div>
                </div>

                <div class="api-endpoint">
                    <h4><span class="method-get">GET</span> /api/companies/{companyId}/flows/{flowId}</h4>
                    <p><strong>Obtener completo</strong> - Devuelve toda la estructura para edici√≥n</p>
                </div>

                <div class="api-endpoint">
                    <h4><span class="method-put">PUT</span> /api/companies/{companyId}/flows/{flowId}</h4>
                    <p><strong>Actualizaci√≥n completa</strong> - Reemplaza toda la configuraci√≥n</p>
                </div>

                <div class="api-endpoint">
                    <h4><span class="method-put">PUT</span> /api/companies/{companyId}/flows/{flowId}/steps/{stepId}</h4>
                    <p><strong>Edici√≥n granular</strong> - Para cambios espec√≠ficos de un paso</p>
                </div>

                <div class="api-endpoint">
                    <h4><span class="method-post">POST</span> /api/companies/{companyId}/flows/{flowId}/steps</h4>
                    <p><strong>Agregar paso</strong> - Para expansi√≥n incremental</p>
                </div>

                <div class="api-endpoint">
                    <h4><span class="method-delete">DELETE</span> /api/companies/{companyId}/flows/{flowId}</h4>
                    <p><strong>Eliminaci√≥n completa</strong> - Borra flujo y dependencias</p>
                </div>
            </div>
        </div>

        <!-- Estructura Simplificada Final -->
        <div class="question-section">
            <div class="question-header">
                üèóÔ∏è Estructura Final Simplificada (Sin CompanyAgent)
            </div>
            <div class="question-content">
                <div class="code-block">-- Estructura simplificada sin CompanyAgent
Company (1) ----< CompanyFlowDefinition (N)
                      |
                      +----< CompanyFlowStep (N)
                      |
                      +----< CompanyFlowCondition (N)
                      |
                      +----< CompanyFlowTool (N)

-- CompanyFlowDefinition ahora incluye configuraci√≥n LLM
ALTER TABLE CompanyFlowDefinition ADD COLUMN json_llm_config JSONB;

-- Ejemplo de json_llm_config:
{
  "model": "gpt-4-turbo",
  "temperature": 0.7,
  "max_tokens": 400,
  "top_p": 0.9,
  "personality": "professional_friendly",
  "language": "es",
  "fallback_enabled": true
}</div>

                <h4>üìã Beneficios de esta simplificaci√≥n:</h4>
                <ul>
                    <li>‚úÖ <strong>Menos JOINs:</strong> Company directamente a FlowDefinition</li>
                    <li>‚úÖ <strong>API m√°s simple:</strong> Un endpoint para crear flow completo</li>
                    <li>‚úÖ <strong>Flexibilidad m√°xima:</strong> Cada flujo puede tener diferentes modelos LLM</li>
                    <li>‚úÖ <strong>Frontend feliz:</strong> Estructura m√°s plana y directa</li>
                    <li>‚úÖ <strong>Escalabilidad:</strong> F√°cil agregar nuevos flujos sin agente intermedio</li>
                </ul>
            </div>
        </div>

        <!-- Ejemplos de Payload -->
        <div class="question-section">
            <div class="question-header">
                üì¶ Ejemplos de Payload para API
            </div>
            <div class="question-content">
                
                <div class="payload-example">
                    <h4>üöÄ POST /api/companies/1/flows (Creaci√≥n Completa)</h4>
                    <div class="code-block">{
  "flow_definition": {
    "vc_flow_name": "ai_appointment",
    "vc_display_name": "Agendamiento de Citas con IA",
    "vc_description": "Flujo inteligente para agendar citas",
    "tx_system_prompt": "Eres un asistente virtual especializado en agendamiento...",
    "tx_user_prompt_template": "{{ current_step == 'initial' ? 'Generar saludo inicial' : 'Procesar paso actual' }}",
    "json_flow_config": {
      "max_steps": 6,
      "timeout_minutes": 30,
      "fallback_enabled": true,
      "auto_advance": true
    },
    "json_llm_config": {
      "model": "gpt-4-turbo",
      "temperature": 0.4,
      "max_tokens": 400,
      "top_p": 0.9,
      "personality": "professional_friendly"
    },
    "b_is_active": true
  },
  "steps": [
    {
      "vc_step_key": "initial",
      "vc_step_name": "Inicializaci√≥n",
      "i_step_order": 1,
      "tx_execution_condition": "$flowInfo.currentStep === 'initial'",
      "tx_step_output": "{{ generate_initial_message }}",
      "json_expected_data": {
        "extract_fields": ["ClientId"],
        "required_fields": ["ClientId"]
      },
      "json_step_config": {
        "use_ai_generation": true,
        "next_step_on_success": "waiting_service"
      }
    },
    {
      "vc_step_key": "waiting_service",
      "vc_step_name": "Selecci√≥n de Servicio",
      "i_step_order": 2,
      "tx_execution_condition": "$flowInfo.currentData.ServiceId == null",
      "tx_step_output": "¬øQu√© servicio necesitas?",
      "json_expected_data": {
        "extract_fields": ["ServiceId"],
        "required_fields": ["ServiceId"]
      },
      "json_step_config": {
        "auto_advance_when_complete": true
      }
    }
    // ... m√°s steps
  ],
  "conditions": [
    {
      "vc_condition_key": "allDataComplete",
      "vc_condition_name": "Todos los datos completos",
      "tx_condition_expression": "$flowInfo.currentData.ServiceId != null && $flowInfo.currentData.ProfessionalId != null && $flowInfo.currentData.DtDate != null && $flowInfo.currentData.TStartTime != null",
      "vc_condition_type": "completion_check"
    }
  ],
  "tools": [
    {
      "vc_tool_type": "llm_generation",
      "vc_tool_name": "Generate Initial Message",
      "json_tool_config": {
        "method": "generate_response",
        "prompt_template": "Crea un saludo inicial...",
        "max_tokens": 200,
        "temperature": 0.7
      },
      "tx_usage_condition": "$flowInfo.currentStep === 'initial'"
    }
    // ... m√°s tools
  ]
}</div>
                </div>

                <div class="payload-example">
                    <h4>üìù PUT /api/companies/1/flows/123/steps/456 (Edici√≥n Granular)</h4>
                    <div class="code-block">{
  "tx_execution_condition": "$flowInfo.currentData.ServiceId == null && !$flowInfo.isBlocked",
  "tx_step_output": "Mensaje actualizado para selecci√≥n de servicio",
  "json_step_config": {
    "auto_advance_when_complete": true,
    "show_suggestions": true,
    "max_suggestions": 8
  }
}</div>
                </div>

                <div class="payload-example">
                    <h4>üîß PUT /api/companies/1/flows/123/llm-config (Configuraci√≥n LLM)</h4>
                    <div class="code-block">{
  "model": "gpt-4-turbo-preview",
  "temperature": 0.3,
  "max_tokens": 500,
  "personality": "more_formal",
  "language": "es-CO",
  "custom_instructions": "Usar muletillas colombianas como 'pues' y 'entonces'"
}</div>
                </div>
            </div>
        </div>

        <!-- Implementaci√≥n en NestJS -->
        <div class="question-section">
            <div class="question-header">
                ‚öôÔ∏è Implementaci√≥n en NestJS/TypeORM
            </div>
            <div class="question-content">
                <div class="code-block">// flows.controller.ts
@Controller('companies/:companyId/flows')
export class FlowsController {
  
  @Post()
  @UsePipes(new ValidationPipe({ transform: true }))
  async createFlow(
    @Param('companyId') companyId: number,
    @Body() createFlowDto: CreateFlowDto
  ): Promise<FlowDefinitionResponseDto> {
    
    return this.flowsService.createFlowComplete(companyId, createFlowDto);
  }
  
  @Get(':flowId')
  async getFlow(
    @Param('companyId') companyId: number,
    @Param('flowId') flowId: number
  ): Promise<FlowDefinitionResponseDto> {
    
    return this.flowsService.getFlowComplete(companyId, flowId);
  }
  
  @Put(':flowId')
  async updateFlow(
    @Param('companyId') companyId: number,
    @Param('flowId') flowId: number,
    @Body() updateFlowDto: UpdateFlowDto
  ): Promise<FlowDefinitionResponseDto> {
    
    return this.flowsService.updateFlowComplete(companyId, flowId, updateFlowDto);
  }
  
  // Endpoints granulares para edici√≥n espec√≠fica
  @Put(':flowId/steps/:stepId')
  async updateStep(
    @Param('flowId') flowId: number,
    @Param('stepId') stepId: number,
    @Body() updateStepDto: UpdateStepDto
  ): Promise<FlowStepDto> {
    
    return this.flowsService.updateStep(flowId, stepId, updateStepDto);
  }
}

// flows.service.ts
@Injectable()
export class FlowsService {
  
  @Transactional()
  async createFlowComplete(companyId: number, dto: CreateFlowDto): Promise<FlowDefinitionResponseDto> {
    
    // 1. Crear FlowDefinition
    const flowDefinition = this.flowDefinitionRepository.create({
      companyId,
      ...dto.flow_definition
    });
    
    await this.flowDefinitionRepository.save(flowDefinition);
    
    // 2. Crear Steps en batch
    if (dto.steps?.length) {
      const steps = dto.steps.map(step => 
        this.flowStepRepository.create({
          flowDefinitionId: flowDefinition.Id,
          ...step
        })
      );
      await this.flowStepRepository.save(steps);
    }
    
    // 3. Crear Conditions en batch  
    if (dto.conditions?.length) {
      const conditions = dto.conditions.map(condition =>
        this.flowConditionRepository.create({
          flowDefinitionId: flowDefinition.Id,
          ...condition
        })
      );
      await this.flowConditionRepository.save(conditions);
    }
    
    // 4. Crear Tools en batch
    if (dto.tools?.length) {
      const tools = dto.tools.map(tool =>
        this.flowToolRepository.create({
          flowDefinitionId: flowDefinition.Id,
          ...tool
        })
      );
      await this.flowToolRepository.save(tools);
    }
    
    // 5. Retornar estructura completa
    return this.getFlowComplete(companyId, flowDefinition.Id);
  }
}</div>
            </div>
        </div>

        <div class="highlight-box">
            <h4>üéØ Conclusiones Finales</h4>
            <p><strong>1. CompanyAgent:</strong> ELIMINAR - No aporta valor real, solo complejidad</p>
            <p><strong>2. API Design:</strong> H√çBRIDO - Endpoint "gordo" para creaci√≥n + granulares para edici√≥n</p>
            <p><strong>3. Frontend Happy:</strong> Una sola llamada para crear, estructura plana para mostrar</p>
            <p><strong>4. Transaccionalidad:</strong> Todo o nada en creaci√≥n, flexibilidad en edici√≥n</p>
        </div>
    </div>
</body>
</html>